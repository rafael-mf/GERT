<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>Editar Chamado #{{ chamadoId }}</h2>
    <button class="btn btn-secondary" [routerLink]="['/chamados', chamadoId]">
      <i class="fas fa-arrow-left me-2"></i>Voltar para Detalhes
    </button>
  </div>

  <div *ngIf="loading && !currentChamado" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando dados do chamado...</span>
    </div>
  </div>

  <div *ngIf="!loading && error" class="alert alert-danger">{{ error }}</div>

  <div *ngIf="!loading && currentChamado" class="card">
    <div class="card-body">
      <form [formGroup]="chamadoForm" (ngSubmit)="onSubmit()">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">Cliente</label>
            <input type="text" class="form-control" [value]="currentChamado.cliente?.nome" readonly>
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">Dispositivo</label>
            <input type="text" class="form-control" [value]="currentChamado.dispositivo?.marca + ' ' + currentChamado.dispositivo?.modelo" readonly>
          </div>

          <div class="col-12 mb-3">
            <label for="titulo" class="form-label">Título do Chamado <span class="text-danger">*</span></label>
            <input type="text" id="titulo" formControlName="titulo" class="form-control"
                   [ngClass]="{ 'is-invalid': submitted && f['titulo'].errors }">
            <div *ngIf="submitted && f['titulo'].errors" class="invalid-feedback">
              <div *ngIf="f['titulo'].errors['required']">Título é obrigatório.</div>
            </div>
          </div>

          <div class="col-12 mb-3">
            <label for="descricao" class="form-label">Descrição do Problema <span class="text-danger">*</span></label>
            <textarea id="descricao" formControlName="descricao" class="form-control" rows="3"
                      [ngClass]="{ 'is-invalid': submitted && f['descricao'].errors }"></textarea>
            <div *ngIf="submitted && f['descricao'].errors" class="invalid-feedback">
              <div *ngIf="f['descricao'].errors['required']">Descrição é obrigatória.</div>
            </div>
          </div>

          <div class="col-12 mb-3">
            <label for="diagnostico" class="form-label">Diagnóstico Técnico</label>
            <textarea id="diagnostico" formControlName="diagnostico" class="form-control" rows="3"></textarea>
          </div>

          <div class="col-12 mb-3">
            <label for="solucao" class="form-label">Solução Aplicada</label>
            <textarea id="solucao" formControlName="solucao" class="form-control" rows="3"></textarea>
          </div>

          <div class="col-md-4 mb-3">
            <label for="prioridadeId" class="form-label">Prioridade <span class="text-danger">*</span></label>
            <select id="prioridadeId" formControlName="prioridadeId" class="form-select"
                    [ngClass]="{ 'is-invalid': submitted && f['prioridadeId'].errors }">
              <option value="" disabled>Selecione</option>
              <option *ngFor="let prioridade of prioridades" [value]="prioridade.id">{{ prioridade.nome }}</option>
            </select>
             <div *ngIf="submitted && f['prioridadeId'].errors" class="invalid-feedback">Prioridade é obrigatória.</div>
          </div>

          <div class="col-md-4 mb-3">
            <label for="statusId" class="form-label">Status <span class="text-danger">*</span></label>
            <select id="statusId" formControlName="statusId" class="form-select"
                    [ngClass]="{ 'is-invalid': submitted && f['statusId'].errors }">
              <option value="" disabled>Selecione</option>
              <option *ngFor="let status of statusList" [value]="status.id">{{ status.nome }}</option>
            </select>
             <div *ngIf="submitted && f['statusId'].errors" class="invalid-feedback">Status é obrigatório.</div>
          </div>

          <div class="col-md-4 mb-3">
            <label for="tecnicoId" class="form-label">Técnico Responsável</label>
            <select id="tecnicoId" formControlName="tecnicoId" class="form-select">
              <option [ngValue]="null">Não atribuído</option>
              <option *ngFor="let tecnico of tecnicos" [value]="tecnico.id">{{ tecnico.usuario?.nome }}</option>
            </select>
          </div>

          <div class="col-md-6 mb-3">
            <label for="dataPrevista" class="form-label">Data Prevista</label>
            <input type="date" id="dataPrevista" formControlName="dataPrevista" class="form-control">
          </div>
           <div class="col-md-6 mb-3">
            <label for="dataFechamento" class="form-label">Data de Fechamento</label>
            <input type="date" id="dataFechamento" formControlName="dataFechamento" class="form-control">
          </div>

          <div class="col-md-6 mb-3">
            <label for="valorTotal" class="form-label">Valor Total (Calculado)</label>
            <input type="text" id="valorTotal" formControlName="valorTotal" class="form-control" readonly>
          </div>

        </div>

        <!-- Seção de Serviços e Peças -->
        <div class="row mt-4" *ngIf="currentChamado">
          <div class="col-12">
            <h5 class="mb-3">Serviços e Peças Utilizadas</h5>

            <!-- Serviços -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Serviços Realizados</h6>
                <button class="btn btn-sm btn-outline-primary" (click)="openServicosModal()">
                  <i class="fas fa-plus me-1"></i>Adicionar Serviço
                </button>
              </div>
              <div *ngIf="currentChamado.servicos && currentChamado.servicos.length > 0" class="card">
                <div class="card-body">
                  <ul class="list-group list-group-flush">
                    <li *ngFor="let cs of currentChamado.servicos" class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <strong>{{ cs.servico?.nome }}</strong>
                        <br><small class="text-muted">{{ cs.observacoes || 'Sem observações' }}</small>
                      </div>
                      <div class="d-flex align-items-center">
                        <span class="badge bg-primary me-2">R$ {{ cs.valor | number:'1.2-2' }}</span>
                        <button class="btn btn-sm btn-outline-danger" (click)="removeServico(cs.id!)" *ngIf="cs.id">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
              <div *ngIf="!currentChamado.servicos || currentChamado.servicos.length === 0" class="text-center py-3 text-muted">
                <i class="fas fa-tools fa-2x mb-2"></i>
                <p>Nenhum serviço adicionado ainda.</p>
              </div>
            </div>

            <!-- Peças -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0">Peças Utilizadas</h6>
                <button class="btn btn-sm btn-outline-primary" (click)="openPecasModal()">
                  <i class="fas fa-plus me-1"></i>Adicionar Peça
                </button>
              </div>
              <div *ngIf="currentChamado.pecasUsadas && currentChamado.pecasUsadas.length > 0" class="card">
                <div class="card-body">
                  <ul class="list-group list-group-flush">
                    <li *ngFor="let peca of currentChamado.pecasUsadas" class="list-group-item d-flex justify-content-between align-items-center">
                      <div>
                        <strong>{{ peca.nome }}</strong>
                        <br><small class="text-muted">{{ peca.descricao || 'Sem descrição' }}</small>
                        <br><small class="text-muted">SN: {{ peca.numeroSerie || 'N/A' }}</small>
                      </div>
                      <div class="d-flex align-items-center">
                        <span class="badge bg-success me-2">R$ {{ peca.valor | number:'1.2-2' }}</span>
                        <button class="btn btn-sm btn-outline-danger" (click)="removePeca(peca.id!)" *ngIf="peca.id">
                          <i class="fas fa-trash"></i>
                        </button>
                      </div>
                    </li>
                  </ul>
                </div>
              </div>
              <div *ngIf="!currentChamado.pecasUsadas || currentChamado.pecasUsadas.length === 0" class="text-center py-3 text-muted">
                <i class="fas fa-cogs fa-2x mb-2"></i>
                <p>Nenhuma peça adicionada ainda.</p>
              </div>
            </div>
          </div>
        </div>

        <div *ngIf="error" class="alert alert-danger mt-3">{{ error }}</div>

        <div class="mt-4 d-flex justify-content-end">
          <button type="button" class="btn btn-outline-secondary me-2" [routerLink]="['/chamados', chamadoId]">Cancelar</button>
          <button *ngIf="podeFecharChamado()" type="button" class="btn btn-success me-2" (click)="fecharChamado()" [disabled]="loading">
            <i class="fas fa-check me-2"></i>Fechar Chamado
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="loading">
            <span *ngIf="loading" class="spinner-border spinner-border-sm me-2"></span>
            {{ loading ? 'Salvando...' : 'Salvar Alterações' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Serviços -->
<div class="modal fade" [class.show]="showServicosModal" [style.display]="showServicosModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adicionar Serviço ao Chamado</h5>
        <button type="button" class="btn-close" (click)="closeServicosModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="servicoSelect" class="form-label">Serviço <span class="text-danger">*</span></label>
            <select id="servicoSelect" class="form-select" [(ngModel)]="selectedServicoId" (change)="onServicoSelected()">
              <option [ngValue]="null" disabled>Selecione um serviço</option>
              <option *ngFor="let servico of servicosDisponiveis" [value]="servico.id">
                {{ servico.nome }} - R$ {{ servico.valorBase | number:'1.2-2' }}
              </option>
            </select>
          </div>
          <div class="col-md-6 mb-3">
            <label for="valorServico" class="form-label">Valor (R$)</label>
            <input type="number" id="valorServico" class="form-control" [(ngModel)]="valorServico" step="0.01" min="0">
          </div>
          <div class="col-12 mb-3">
            <label for="observacoesServico" class="form-label">Observações</label>
            <textarea id="observacoesServico" class="form-control" [(ngModel)]="observacoesServico" rows="3"
                      placeholder="Observações sobre o serviço realizado"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeServicosModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="addServico()" [disabled]="addingServico || !selectedServicoId">
          <span *ngIf="addingServico" class="spinner-border spinner-border-sm me-2"></span>
          {{ addingServico ? 'Adicionando...' : 'Adicionar Serviço' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Peças -->
<div class="modal fade" [class.show]="showPecasModal" [style.display]="showPecasModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adicionar Peça ao Chamado</h5>
        <button type="button" class="btn-close" (click)="closePecasModal()"></button>
      </div>
      <div class="modal-body">
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="nomePeca" class="form-label">Nome da Peça <span class="text-danger">*</span></label>
            <input type="text" id="nomePeca" class="form-control" [(ngModel)]="nomePeca" placeholder="Ex: Placa Mãe">
          </div>
          <div class="col-md-6 mb-3">
            <label for="valorPeca" class="form-label">Valor (R$) <span class="text-danger">*</span></label>
            <input type="number" id="valorPeca" class="form-control" [(ngModel)]="valorPeca" step="0.01" min="0">
          </div>
          <div class="col-md-6 mb-3">
            <label for="numeroSeriePeca" class="form-label">Número de Série</label>
            <input type="text" id="numeroSeriePeca" class="form-control" [(ngModel)]="numeroSeriePeca" placeholder="Ex: SN123456">
          </div>
          <div class="col-md-6 mb-3">
            <label for="garantiaPeca" class="form-label">Garantia</label>
            <input type="text" id="garantiaPeca" class="form-control" [(ngModel)]="garantiaPeca" placeholder="Ex: 1 ano">
          </div>
          <div class="col-12 mb-3">
            <label for="descricaoPeca" class="form-label">Descrição</label>
            <textarea id="descricaoPeca" class="form-control" [(ngModel)]="descricaoPeca" rows="3"
                      placeholder="Descrição detalhada da peça"></textarea>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closePecasModal()">Cancelar</button>
        <button type="button" class="btn btn-primary" (click)="addPeca()" [disabled]="addingPeca || !nomePeca || !valorPeca">
          <span *ngIf="addingPeca" class="spinner-border spinner-border-sm me-2"></span>
          {{ addingPeca ? 'Adicionando...' : 'Adicionar Peça' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop para os modais -->
<div *ngIf="showServicosModal" class="modal-backdrop fade show" (click)="closeServicosModal()"></div>
<div *ngIf="showPecasModal" class="modal-backdrop fade show" (click)="closePecasModal()"></div>
