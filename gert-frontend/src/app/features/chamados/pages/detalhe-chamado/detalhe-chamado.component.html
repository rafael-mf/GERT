<div class="container-fluid">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 *ngIf="chamado">Detalhes do Chamado #{{ chamado.id }}</h2>
    <h2 *ngIf="!chamado && !loading">Chamado Não Encontrado</h2>
    <div>
      <button class="btn btn-outline-secondary me-2" routerLink="/chamados">
        <i class="fas fa-arrow-left me-2"></i>Voltar para Lista
      </button>
      <button *ngIf="chamado" class="btn btn-primary" (click)="editChamado()">
        <i class="fas fa-edit me-2"></i>Editar Chamado
      </button>
    </div>
  </div>

  <div *ngIf="loading" class="text-center my-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
  </div>

  <div *ngIf="!loading && error" class="alert alert-danger">{{ error }}</div>

  <div *ngIf="!loading && chamado" class="card">
    <div class="card-header">
      <h5 class="mb-0">{{ chamado.titulo }}</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-8">
          <h6>Informações Gerais</h6>
          <table class="table table-sm table-borderless">
            <tr>
              <td style="width: 150px;"><strong>Cliente:</strong></td>
              <td>{{ chamado.cliente?.nome }}</td>
            </tr>
            <tr>
              <td><strong>Dispositivo:</strong></td>
              <td>{{ chamado.dispositivo?.marca }} {{ chamado.dispositivo?.modelo }} (S/N: {{ chamado.dispositivo?.numeroSerie || 'N/A' }})</td>
            </tr>
             <tr>
              <td><strong>Status:</strong></td>
              <td><span class="badge" [style.background-color]="chamado.status?.cor || '#6c757d'">{{ chamado.status?.nome }}</span></td>
            </tr>
            <tr>
              <td><strong>Prioridade:</strong></td>
              <td><span class="badge" [style.background-color]="chamado.prioridade?.cor || '#6c757d'">{{ chamado.prioridade?.nome }}</span></td>
            </tr>
            <tr>
              <td><strong>Técnico:</strong></td>
              <td>{{ chamado.tecnico?.usuario?.nome || 'Não atribuído' }}</td>
            </tr>
            <tr>
              <td><strong>Data Abertura:</strong></td>
              <td>{{ chamado.dataAbertura | date:'dd/MM/yyyy HH:mm' }}</td>
            </tr>
            <tr>
              <td><strong>Data Prevista:</strong></td>
              <td>{{ chamado.dataPrevista ? (chamado.dataPrevista | date:'dd/MM/yyyy') : 'Não definida' }}</td>
            </tr>
            <tr *ngIf="chamado.dataFechamento">
              <td><strong>Data Fechamento:</strong></td>
              <td>{{ chamado.dataFechamento | date:'dd/MM/yyyy HH:mm' }}</td>
            </tr>
          </table>

          <h6 class="mt-4">Descrição do Problema</h6>
          <p class="bg-light p-3 rounded">{{ chamado.descricao }}</p>

          <div *ngIf="chamado.diagnostico">
            <h6 class="mt-4">Diagnóstico Técnico</h6>
            <p class="bg-light p-3 rounded">{{ chamado.diagnostico }}</p>
          </div>

          <div *ngIf="chamado.solucao">
            <h6 class="mt-4">Solução Aplicada</h6>
            <p class="bg-light p-3 rounded">{{ chamado.solucao }}</p>
          </div>
        </div>

        <div class="col-md-4">
          <h6>Financeiro</h6>
          <div class="card bg-light">
            <div class="card-body">
              <h4 class="text-success">Valor Total: {{ chamado.valorTotal | currency:'BRL':'symbol':'1.2-2' }}</h4>
            </div>
          </div>

          <h6 class="mt-4">Serviços Realizados</h6>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span></span>
            <button class="btn btn-sm btn-outline-primary" (click)="openServicosModal()">
              <i class="fas fa-plus me-1"></i>Gerenciar Serviços
            </button>
          </div>
          <ul *ngIf="chamado.servicos && chamado.servicos.length > 0" class="list-group">
            <li *ngFor="let cs of chamado.servicos" class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                {{ cs.servico?.nome }}
                <small *ngIf="cs.observacoes" class="d-block text-muted">{{cs.observacoes}}</small>
              </div>
              <div class="d-flex align-items-center">
                <span class="me-2">{{ cs.valor | currency:'BRL' }}</span>
                <button *ngIf="cs.id" class="btn btn-sm btn-outline-danger" (click)="removeServico(cs.id)" title="Remover serviço">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </li>
          </ul>
          <p *ngIf="!chamado.servicos || chamado.servicos.length === 0" class="text-muted">Nenhum serviço adicionado.</p>

          <h6 class="mt-4">Peças Utilizadas</h6>
          <div class="d-flex justify-content-between align-items-center mb-2">
            <span></span>
            <button class="btn btn-sm btn-outline-primary" (click)="openPecasModal()">
              <i class="fas fa-plus me-1"></i>Adicionar Peça
            </button>
          </div>
          <ul *ngIf="chamado.pecasUsadas && chamado.pecasUsadas.length > 0" class="list-group">
            <li *ngFor="let pu of chamado.pecasUsadas" class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                {{ pu.nome }}
                <small *ngIf="pu.descricao" class="d-block text-muted">{{ pu.descricao }}</small>
                <small *ngIf="pu.numeroSerie" class="d-block text-muted">N/S: {{ pu.numeroSerie }}</small>
              </div>
              <div class="d-flex align-items-center">
                <span class="me-2">{{ pu.valor | currency:'BRL' }}</span>
                <button *ngIf="pu.id" class="btn btn-sm btn-outline-danger" (click)="removePeca(pu.id)" title="Remover peça">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </li>
          </ul>
          <p *ngIf="!chamado.pecasUsadas || chamado.pecasUsadas.length === 0" class="text-muted">Nenhuma peça adicionada.</p>
        </div>
      </div>

      <!-- Ações do Chamado -->
      <div class="mt-4">
        <h6>Ações do Chamado</h6>
        <div class="d-flex gap-2 flex-wrap">
          <!-- Botão para fechar chamado (apenas se não estiver fechado) -->
          <button
            *ngIf="chamado && chamado.status && !['Concluído', 'Fechado', 'Cancelado'].includes(chamado.status.nome)"
            class="btn btn-success btn-sm"
            (click)="fecharChamado()">
            <i class="fas fa-check me-2"></i>Fechar Chamado
          </button>

          <!-- Botão para reabrir chamado (apenas se estiver fechado) -->
          <button
            *ngIf="chamado && chamado.status && ['Concluído', 'Fechado', 'Cancelado'].includes(chamado.status.nome)"
            class="btn btn-warning btn-sm"
            (click)="reabrirChamado()">
            <i class="fas fa-undo me-2"></i>Reabrir Chamado
          </button>

          <!-- Botão para adicionar comentário -->
          <button class="btn btn-info btn-sm" (click)="adicionarComentario()">
            <i class="fas fa-comment me-2"></i>Adicionar Comentário
          </button>
        </div>
      </div>

      <h6 class="mt-4">Histórico do Chamado</h6>
      <div *ngIf="loadingAtualizacoes" class="text-center my-3">
        <div class="spinner-border spinner-border-sm text-primary" role="status">
          <span class="visually-hidden">Carregando histórico...</span>
        </div>
      </div>

      <div *ngIf="!loadingAtualizacoes && atualizacoes.length > 0" class="timeline">
        <div *ngFor="let atualizacao of atualizacoes; let i = index" class="timeline-item mb-3">
          <div class="timeline-marker">
            <i class="fas fa-clock text-primary"></i>
          </div>
          <div class="timeline-content card">
            <div class="card-body p-3">
              <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                  <strong>{{ atualizacao.usuario.nome }}</strong>
                  <small class="text-muted d-block">{{ atualizacao.usuario.email }}</small>
                </div>
                <small class="text-muted">{{ atualizacao.dataAtualizacao | date:'dd/MM/yyyy HH:mm' }}</small>
              </div>

              <!-- Mudança de Status -->
              <div *ngIf="atualizacao.statusAnterior && atualizacao.statusNovo" class="mb-2">
                <span class="badge me-2" [style.background-color]="atualizacao.statusAnteriorObj?.cor || '#6c757d'">
                  {{ atualizacao.statusAnteriorObj?.nome }}
                </span>
                <i class="fas fa-arrow-right text-muted mx-2"></i>
                <span class="badge" [style.background-color]="atualizacao.statusNovoObj?.cor || '#6c757d'">
                  {{ atualizacao.statusNovoObj?.nome }}
                </span>
              </div>

              <!-- Apenas Status Novo (criação) -->
              <div *ngIf="!atualizacao.statusAnterior && atualizacao.statusNovo" class="mb-2">
                <span class="badge" [style.background-color]="atualizacao.statusNovoObj?.cor || '#6c757d'">
                  Status: {{ atualizacao.statusNovoObj?.nome }}
                </span>
              </div>

              <!-- Comentário -->
              <div *ngIf="atualizacao.comentario" class="mt-2">
                <p class="mb-0 text-muted">{{ atualizacao.comentario }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div *ngIf="!loadingAtualizacoes && atualizacoes.length === 0" class="alert alert-info">
        <i class="fas fa-info-circle me-2"></i>
        Nenhum histórico de atualizações encontrado para este chamado.
      </div>
    </div>
  </div>
</div>

<!-- Modal de Serviços -->
<div class="modal fade" [class.show]="showServicosModal" [style.display]="showServicosModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adicionar Serviço ao Chamado</h5>
        <button type="button" class="btn-close" (click)="closeServicosModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="servicoSelect" class="form-label">Serviço</label>
            <select
              id="servicoSelect"
              class="form-select"
              [(ngModel)]="selectedServicoId"
              (change)="onServicoSelected()"
              name="servicoId"
              required>
              <option value="">Selecione um serviço...</option>
              <option *ngFor="let servico of servicosDisponiveis" [value]="servico.id">
                {{ servico.nome }} - {{ servico.valorBase | currency:'BRL' }}
              </option>
            </select>
          </div>

          <div class="mb-3">
            <label for="valorInput" class="form-label">Valor (R$)</label>
            <input
              type="number"
              id="valorInput"
              class="form-control"
              [(ngModel)]="valorServico"
              name="valor"
              step="0.01"
              min="0"
              placeholder="Valor do serviço">
          </div>

          <div class="mb-3">
            <label for="observacoesTextarea" class="form-label">Observações</label>
            <textarea
              id="observacoesTextarea"
              class="form-control"
              [(ngModel)]="observacoesServico"
              name="observacoes"
              rows="3"
              placeholder="Observações sobre o serviço realizado"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeServicosModal()">Cancelar</button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="addServico()"
          [disabled]="addingServico || !selectedServicoId">
          <span *ngIf="addingServico" class="spinner-border spinner-border-sm me-2"></span>
          Adicionar Serviço
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop do modal -->
<div *ngIf="showServicosModal" class="modal-backdrop fade show" (click)="closeServicosModal()"></div>

<!-- Modal de Peças -->
<div class="modal fade" [class.show]="showPecasModal" [style.display]="showPecasModal ? 'block' : 'none'" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Adicionar Peça ao Chamado</h5>
        <button type="button" class="btn-close" (click)="closePecasModal()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="mb-3">
            <label for="nomePecaInput" class="form-label">Nome da Peça *</label>
            <input
              type="text"
              id="nomePecaInput"
              class="form-control"
              [(ngModel)]="nomePeca"
              name="nomePeca"
              placeholder="Nome da peça utilizada"
              required>
          </div>

          <div class="mb-3">
            <label for="valorPecaInput" class="form-label">Valor (R$) *</label>
            <input
              type="number"
              id="valorPecaInput"
              class="form-control"
              [(ngModel)]="valorPeca"
              name="valorPeca"
              step="0.01"
              min="0"
              placeholder="Valor da peça">
          </div>

          <div class="mb-3">
            <label for="descricaoPecaTextarea" class="form-label">Descrição</label>
            <textarea
              id="descricaoPecaTextarea"
              class="form-control"
              [(ngModel)]="descricaoPeca"
              name="descricaoPeca"
              rows="2"
              placeholder="Descrição da peça"></textarea>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="numeroSerieInput" class="form-label">Número de Série</label>
              <input
                type="text"
                id="numeroSerieInput"
                class="form-control"
                [(ngModel)]="numeroSeriePeca"
                name="numeroSerie"
                placeholder="N/S da peça">
            </div>
            <div class="col-md-6 mb-3">
              <label for="garantiaInput" class="form-label">Garantia</label>
              <input
                type="text"
                id="garantiaInput"
                class="form-control"
                [(ngModel)]="garantiaPeca"
                name="garantia"
                placeholder="Período de garantia">
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closePecasModal()">Cancelar</button>
        <button
          type="button"
          class="btn btn-primary"
          (click)="addPeca()"
          [disabled]="addingPeca || !nomePeca || !valorPeca">
          <span *ngIf="addingPeca" class="spinner-border spinner-border-sm me-2"></span>
          Adicionar Peça
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Backdrop do modal -->
<div *ngIf="showPecasModal" class="modal-backdrop fade show" (click)="closePecasModal()"></div>
